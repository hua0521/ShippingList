<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品出貨清單 Pro</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Tesseract.js (保留引用) -->
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@500&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Noto Sans TC', 'Inter', sans-serif; 
            background-color: #f1f5f9; /* Slate-100 */
            color: #1e293b; /* Slate-800 */
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #ffffff;
            animation: spin 1s ease infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Cropping Styles */
        .crop-container {
            position: relative;
            overflow: hidden;
            user-select: none;
            cursor: crosshair;
            display: inline-block;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .crop-selection {
            position: absolute;
            border: 2px dashed #fbbf24; /* Amber-400 */
            background-color: rgba(251, 191, 36, 0.2);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75);
            pointer-events: none;
        }
        
        @media print {
            @page {
                size: A4 portrait;
                margin: 5mm; /* 保留極小邊距 */
            }
            html, body {
                height: 100%;
                margin: 0 !important;
                padding: 0 !important;
                overflow: hidden; 
                background-color: white;
            }
            /* Global reset for print to prevent layout shifts */
            * {
                box-sizing: border-box !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .no-print { display: none !important; }
            
            .print-container {
                min-height: auto !important;
                height: calc(100vh - 10mm) !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                display: flex !important;
                flex-direction: column;
                justify-content: space-between;
                width: 100% !important;
                max-width: none !important;
            }

            .bill-copy { 
                page-break-inside: avoid; 
                margin-bottom: 0 !important;
                border: none !important; 
                box-shadow: none !important;
                flex: 1; 
                min-height: 0; 
                height: auto !important; 
            }

            /* 強制列印時邊框為黑色且加粗，並保留圓角 */
            .print-border {
                border: 1px solid #000 !important; 
                border-radius: 0.75rem !important; 
            }
            
            .print-border-dashed {
                border: 1px dashed #000 !important; 
                border-radius: 0.75rem !important; 
            }

            .bill-copy.unified {
                border: 1px solid #000 !important; 
                border-radius: 0.75rem !important; 
            }
            
            /* 表格/區塊內部線條維持 1px 黑色 */
            .print\:border-black { border-color: #000 !important; }
            
            /* 修正表格內圓角溢出問題 */
            table { border-radius: 0.75rem; border-collapse: separate !important; border-spacing: 0; overflow: hidden; }
            /* 處理表格邊框重疊 */
            th:first-child { border-top-left-radius: 0.75rem; }
            
            .text-gray-500 { color: #000 !important; }
            .bg-gray-100 { background-color: #f3f4f6 !important; } 
            .bg-slate-50 { background-color: #fff !important; }
            .bg-slate-800, .bg-gray-600 { 
                background-color: #333 !important; 
                color: #fff !important; 
                border-radius: 9999px !important; 
            }
            
            img { max-width: 100% !important; }
            
            .cut-separator div { background: white; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Component: Bill Template ---
        const BillTemplate = ({ titleTag, orderData, img1, img2, mode }) => {
            const isCutMode = mode === 'cut'; 
            
            const containerHeight = "h-[500px] print:h-auto";
            const headerBg = isCutMode ? "bg-slate-800" : "bg-gray-600";
            
            const headerTextSize = "text-xl font-bold tracking-wide";
            
            // Unified styles for ID and Name
            const infoTextSize = "text-xl font-bold"; 
            const labelTextSize = "text-[10px] uppercase tracking-wider font-semibold text-gray-500";
            const noteTextSize = "text-sm font-medium";
            
            // Sub-component: Left Content (Vertical Layout, No Checkbox)
            const LeftContent = () => (
                <div className="flex flex-col h-full w-full bg-white rounded-xl overflow-hidden">
                    
                    {/* Top Section: Order Details */}
                    <div className="flex flex-col border-b border-gray-300 print:border-black shrink-0">
                        <div className="h-8 bg-gray-100 border-b border-gray-300 print:border-black flex items-center px-3 text-xs text-gray-800 font-bold shrink-0">
                            訂單資訊
                        </div>
                        <div className="p-2 flex flex-wrap gap-x-4 gap-y-1 items-start bg-white">
                            <div className="flex-1 min-w-[140px]">
                                <div className={labelTextSize}>訂單編號</div>
                                <div className={`font-mono ${infoTextSize} leading-tight break-all text-gray-900 mt-0.5`}>{orderData.orderId || "-"}</div>
                            </div>
                            <div className="flex-1 min-w-[100px]">
                                <div className={labelTextSize}>購買人</div>
                                <div className={`${infoTextSize} leading-tight break-all text-gray-900 mt-0.5`}>{orderData.buyerName || "-"}</div>
                            </div>
                            {orderData.note && (
                                <div className={`w-full mt-1 text-red-700 bg-red-50 p-1.5 rounded border-l-4 border-red-500 ${noteTextSize}`}>
                                    <i className="fas fa-exclamation-triangle mr-1"></i>{orderData.note}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Bottom Section: Product Content (Takes remaining space) */}
                    <div className="flex flex-col flex-grow min-h-0">
                        <div className="h-8 bg-gray-100 border-b border-gray-300 print:border-black flex items-center px-3 text-xs text-gray-800 font-bold shrink-0">
                            商品內容
                        </div>
                        <div className="flex-grow relative w-full min-h-0 p-0 bg-white">
                            <div className="flex flex-col w-full h-full">
                                {img1 ? (
                                    <div className="flex-grow relative w-full h-full min-h-0 overflow-hidden group">
                                        <img 
                                            src={img1} 
                                            alt="商品明細" 
                                            className="absolute inset-0 w-full h-full object-contain object-top transition-transform duration-500" 
                                        />
                                    </div>
                                ) : (
                                    <div className="flex-grow flex flex-col items-center justify-center text-gray-300 h-full bg-slate-50">
                                        <i className="fas fa-image text-4xl mb-2"></i>
                                        <span className="text-xs">等待圖片上傳...</span>
                                    </div>
                                )}
                                {orderData.products && (
                                    <div className={`py-1.5 px-3 border-t border-dashed border-gray-300 print:border-black bg-gray-50 text-gray-700 shrink-0 ${noteTextSize}`}>
                                        <span className="font-bold text-gray-900">備註：</span> {orderData.products}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );

            // Sub-component: Right Content (Receipt)
            const RightContent = () => (
                <div className={`flex flex-col h-full w-full overflow-hidden ${isCutMode ? 'bg-amber-50' : 'bg-gray-50'}`}>
                    <div className={`h-8 flex items-center justify-center text-[10px] font-bold tracking-widest border-b border-gray-300 print:border-black shrink-0 w-full uppercase ${isCutMode ? 'bg-amber-100 text-amber-800' : 'bg-gray-200 text-gray-600'}`} style={{ borderBottomWidth: '1px' }}>
                        {isCutMode ? <><i className="fas fa-cut mr-1"></i>物流單 (請剪下)</> : '存根聯 (留存)'}
                    </div>
                    <div className="p-2 flex-grow flex flex-col items-center justify-center relative min-h-0 overflow-hidden w-full">
                        {img2 ? (
                            <div className="flex flex-col items-center justify-center w-full h-full">
                                <img 
                                    src={img2} 
                                    alt="小白單影像" 
                                    className="w-full h-full object-contain mix-blend-multiply"
                                    style={{ maxHeight: '95%' }}
                                />
                                {orderData.trackingNumber && (
                                    <span className="text-[10px] text-gray-500 mt-1 font-mono bg-white/80 px-2 py-0.5 rounded border border-gray-200 shrink-0 shadow-sm">{orderData.trackingNumber}</span>
                                )}
                            </div>
                        ) : (
                            <div className="text-gray-300 flex flex-col items-center">
                                <i className="fas fa-barcode text-5xl mb-2 opacity-20"></i>
                                <span className="text-[10px] uppercase tracking-wide">No Slip</span>
                            </div>
                        )}
                    </div>
                </div>
            );

            // Header
            const Header = () => (
                <div className="flex justify-between items-center px-4 py-1.5 bg-white border-b border-gray-200 print:border-black shrink-0" style={{ borderBottomWidth: '1px' }}>
                    <h2 className={`flex items-center text-gray-800 ${headerTextSize}`}>
                        <i className="fas fa-file-invoice mr-2 text-slate-400"></i>
                        商品出貨清單 
                        <span className={`ml-3 text-xs font-bold text-white px-3 py-1 rounded-full shadow-sm ${headerBg} print-color-adjust`}>
                            {titleTag}
                        </span>
                    </h2>
                    {/* Date displayed for both modes now */}
                    <div className="text-right flex items-center gap-2 text-gray-500">
                        <i className="far fa-calendar-alt text-xs"></i>
                        <div className="text-xs font-mono">{new Date().toLocaleDateString()}</div>
                    </div>
                </div>
            );

            if (isCutMode) {
                // --- 隨貨寄出聯 (分離式設計) ---
                return (
                    // Gap reduced to 2
                    <div className={`bill-copy flex gap-2 print:gap-3 items-stretch ${containerHeight} bg-transparent border-0 shadow-none rounded-none p-0`}>
                        {/* 左側：商品出貨清單 - 寬度調整為 58% (保留 gap 空間) */}
                        <div className="flex-grow flex flex-col w-[58%] border-2 border-gray-300 rounded-xl overflow-hidden bg-white shadow-sm print-border">
                            <Header />
                            <div className="flex-grow min-h-0 relative">
                                <LeftContent />
                            </div>
                        </div>

                        {/* 中間：剪裁線 */}
                        <div className="flex flex-col items-center justify-center relative w-0 border-l-2 border-dashed border-gray-300 shrink-0" style={{borderWidth: '0 0 0 2px'}}>
                            <div className="absolute bg-white text-gray-400 p-0.5 rounded-full border border-gray-200 print:hidden">
                                <i className="fas fa-cut text-xs"></i>
                            </div>
                        </div>

                        {/* 右側：物流單 - 寬度增加至 38% (Total 96% + gap + divider) */}
                        <div className="w-[38%] min-w-[150px] flex flex-col border-2 border-gray-400 border-dashed rounded-xl overflow-hidden bg-white shadow-sm relative print-border-dashed">
                            <RightContent />
                        </div>
                    </div>
                );
            } else {
                // --- 賣家存根聯 (合併式設計) ---
                return (
                    <div className={`bill-copy unified rounded-xl overflow-hidden flex flex-col border-2 border-gray-300 bg-white shadow-sm ${containerHeight} print-border`}>
                        <Header />
                        <div className="flex items-stretch flex-grow min-h-0 relative">
                            {/* 左側內容 - 寬度調整為 60% */}
                            <div className="flex-grow flex flex-col w-[60%] border-r border-gray-300 print:border-black" style={{ borderRightWidth: '1px' }}>
                                <LeftContent />
                            </div>
                            {/* 右側內容 - 寬度增加至 40% */}
                            <div className="w-[40%] min-w-[150px] flex flex-col"> 
                                <RightContent />
                            </div>
                        </div>
                    </div>
                );
            }
        };

        function App() {
            const [img1, setImg1] = useState(null);
            const [text1, setText1] = useState("");
            const [progress1, setProgress1] = useState(0);
            
            const [img2, setImg2] = useState(null);
            const [text2, setText2] = useState("");
            const [progress2, setProgress2] = useState(0);

            // Drag/Hover states
            const [dragOverOrder, setDragOverOrder] = useState(false);
            const [dragOverReceipt, setDragOverReceipt] = useState(false);
            const [hoverOrder, setHoverOrder] = useState(false);
            const [hoverReceipt, setHoverReceipt] = useState(false);

            const [orderData, setOrderData] = useState({
                orderId: "",
                buyerName: "",
                products: "", 
                trackingNumber: "",
                note: ""
            });

            const [isProcessing, setIsProcessing] = useState(false);
            const [statusMessage, setStatusMessage] = useState("");
            
            const [croppingTarget, setCroppingTarget] = useState(null);
            const [cropStart, setCropStart] = useState(null);
            const [cropRect, setCropRect] = useState(null);
            const cropImgRef = useRef(null);

            // --- Unified File Processor ---
            const processFile = async (file, target) => {
                if (!file) return;
                
                if (!file.type.startsWith('image/') && file.type !== 'application/pdf') {
                    setStatusMessage("檔案格式不支援，請上傳圖片或 PDF");
                    setTimeout(() => setStatusMessage(""), 2000);
                    return;
                }

                if (file.type === 'application/pdf') {
                    setIsProcessing(true);
                    setStatusMessage(`正在處理 PDF...`);
                    try {
                        const imgData = await convertPdfToImage(file);
                        if (target === 'order') setImg1(imgData);
                        else setImg2(imgData);
                        setStatusMessage("PDF 匯入成功");
                    } catch (error) {
                        console.error("PDF Error:", error);
                        setStatusMessage("PDF 處理失敗");
                    } finally {
                        setIsProcessing(false);
                        setTimeout(() => setStatusMessage(""), 2000);
                    }
                } else {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        if (target === 'order') setImg1(event.target.result);
                        else setImg2(event.target.result);
                        setStatusMessage("圖片匯入成功");
                        setTimeout(() => setStatusMessage(""), 2000);
                    };
                    reader.readAsDataURL(file);
                }
            };

            // --- Handlers ---
            const handleImageUpload = (e, target) => {
                const file = e.target.files[0];
                processFile(file, target);
            };

            const handleDrop = (e, target) => {
                e.preventDefault();
                e.stopPropagation();
                if (target === 'order') setDragOverOrder(false);
                else setDragOverReceipt(false);

                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    processFile(e.dataTransfer.files[0], target);
                }
            };

            const handleDragOver = (e, target) => {
                e.preventDefault();
                e.stopPropagation();
                if (target === 'order') setDragOverOrder(true);
                else setDragOverReceipt(true);
            };

            const handleDragLeave = (e, target) => {
                e.preventDefault();
                e.stopPropagation();
                if (target === 'order') setDragOverOrder(false);
                else setDragOverReceipt(false);
            };

            // --- Global Paste Handler ---
            useEffect(() => {
                const handlePaste = (e) => {
                    const items = e.clipboardData.items;
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf("image") !== -1) {
                            const blob = items[i].getAsFile();
                            // If user is hovering over receipt area, paste there. Default to order.
                            const target = hoverReceipt ? 'receipt' : 'order'; 
                            processFile(blob, target);
                            
                            const targetName = target === 'order' ? "商品明細" : "小白單";
                            setStatusMessage(`已貼上圖片至：${targetName}`);
                            e.preventDefault();
                            break;
                        }
                    }
                };
                window.addEventListener('paste', handlePaste);
                return () => window.removeEventListener('paste', handlePaste);
            }, [hoverReceipt]); 

            // --- Helper Functions ---
            const convertPdfToImage = async (file) => {
                const pdfjsLib = window['pdfjs-dist/build/pdf'];
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({ scale: 2.0 });

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;

                return canvas.toDataURL('image/png');
            };

            const handleScreenCapture = async (target) => {
                setStatusMessage("準備截圖...");
                try {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
                        throw new Error("API_NOT_SUPPORTED");
                    }
                    const stream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: "never" }, audio: false });
                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.onloadedmetadata = async () => {
                        video.play();
                        await new Promise(r => setTimeout(r, 500));
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0);
                        const imgData = canvas.toDataURL('image/png');
                        stream.getTracks().forEach(track => track.stop());
                        
                        if (target === 'order') setImg1(imgData); else setImg2(imgData);
                        setStatusMessage("螢幕截圖成功");
                        setTimeout(() => setStatusMessage(""), 2000);
                    };
                } catch (err) {
                    console.error("Screen capture error:", err);
                    if (err.name === 'NotAllowedError' || err.name === 'SecurityError') {
                        setStatusMessage("環境限制無法截圖，請按 Ctrl+V 貼上");
                    } else if (err.message === "API_NOT_SUPPORTED") {
                        setStatusMessage("此瀏覽器不支援截圖，請用 Ctrl+V");
                    } else {
                        setStatusMessage("截圖錯誤，請改用上傳或貼上");
                    }
                    setTimeout(() => setStatusMessage(""), 3000);
                }
            };

            const startCrop = (e) => { e.preventDefault(); const r = e.target.getBoundingClientRect(); setCropStart({x: e.clientX-r.left, y: e.clientY-r.top, width: r.width, height: r.height}); setCropRect(null); };
            const doCrop = (e) => { if(!cropStart) return; e.preventDefault(); const r = e.target.getBoundingClientRect(); const cx = e.clientX-r.left, cy = e.clientY-r.top; setCropRect({x: Math.min(cropStart.x, cx), y: Math.min(cropStart.y, cy), w: Math.abs(cx-cropStart.x), h: Math.abs(cy-cropStart.y)}); };
            const endCrop = () => setCropStart(null);
            const confirmCrop = async () => {
                if (!cropRect || !cropImgRef.current) return;
                const img = cropImgRef.current; const sx = img.naturalWidth/img.width; const sy = img.naturalHeight/img.height;
                const canvas = document.createElement('canvas'); canvas.width = cropRect.w*sx; canvas.height = cropRect.h*sy;
                const ctx = canvas.getContext('2d'); ctx.drawImage(img, cropRect.x*sx, cropRect.y*sy, cropRect.w*sx, cropRect.h*sy, 0, 0, canvas.width, canvas.height);
                const url = canvas.toDataURL('image/png');
                if (croppingTarget==='order') { setImg1(url); } else { setImg2(url); }
                setCroppingTarget(null); setCropRect(null);
            };
            const cancelCrop = () => { setCroppingTarget(null); setCropRect(null); };
            
            const handlePrint = () => {
                const now = new Date();
                const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
                const safeOrderId = (orderData.orderId || "無編號").replace(/[\/\\?%*:|"<>]/g, '-').trim();
                const newTitle = `${dateStr}_商品出貨清單_${safeOrderId}`;
                const originalTitle = document.title;
                document.title = newTitle;
                window.print();
                setTimeout(() => { document.title = originalTitle; }, 1000);
            };

            const clearAll = () => { setImg1(null); setText1(""); setProgress1(0); setImg2(null); setText2(""); setProgress2(0); setOrderData({ orderId: "", buyerName: "", products: "", trackingNumber: "", note: "" }); setStatusMessage(""); };

            const renderCropper = () => {
                const imgSrc = croppingTarget === 'order' ? img1 : img2;
                if (!imgSrc) return null;
                return (
                    <div className="fixed inset-0 z-[100000] bg-slate-900/95 flex items-center justify-center p-6 backdrop-blur-sm">
                        <div className="bg-white rounded-2xl overflow-hidden max-w-6xl w-full flex flex-col h-[90vh] shadow-2xl animate-fade-in">
                            <div className="p-5 bg-slate-800 text-white flex justify-between items-center shrink-0">
                                <div><h3 className="font-bold text-xl flex items-center"><i className="fas fa-crop-alt mr-3 text-amber-400"></i>圖片裁切工具</h3></div>
                                <button onClick={cancelCrop}><i className="fas fa-times text-xl"></i></button>
                            </div>
                            <div className="flex-1 overflow-auto bg-slate-900 flex justify-center items-center p-8 relative cursor-crosshair">
                                <div className="crop-container" onMouseDown={startCrop} onMouseMove={doCrop} onMouseUp={endCrop} onMouseLeave={endCrop}>
                                    <img ref={cropImgRef} src={imgSrc} className="max-w-none shadow-2xl" style={{ maxHeight: '70vh', maxWidth: '100%' }} draggable={false}/>
                                    {cropRect && <div className="crop-selection" style={{ left: cropRect.x, top: cropRect.y, width: cropRect.w, height: cropRect.h }}></div>}
                                </div>
                            </div>
                            <div className="p-6 border-t border-slate-200 bg-white flex justify-end gap-4 shrink-0">
                                <button onClick={cancelCrop} className="px-6 py-2.5 text-slate-600 hover:bg-slate-100 rounded-lg font-medium transition">取消</button>
                                <button onClick={confirmCrop} disabled={!cropRect} className={`px-8 py-2.5 rounded-lg text-white font-bold flex items-center shadow-lg transition transform hover:-translate-y-0.5 ${cropRect ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-slate-300 cursor-not-allowed'}`}><i className="fas fa-check mr-2"></i>確認裁切</button>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen pb-48 font-sans">
                    <div className="bg-gradient-to-r from-slate-900 via-slate-800 to-indigo-900 text-white p-6 shadow-xl no-print relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-4 opacity-10"><i className="fas fa-shipping-fast text-9xl"></i></div>
                        <div className="max-w-6xl mx-auto flex justify-between items-center relative z-10">
                            <div>
                                <h1 className="text-3xl font-bold tracking-tight flex items-center gap-3">
                                    <span className="bg-indigo-500 w-10 h-10 rounded-lg flex items-center justify-center shadow-lg"><i className="fas fa-box-open text-xl"></i></span>
                                    商品出貨清單 <span className="text-indigo-300 text-sm font-normal self-end mb-1 ml-2">v3.0 Pro</span>
                                </h1>
                                <p className="text-slate-300 text-sm mt-2 ml-14">支援拖放 / Ctrl+V 貼上 / 螢幕截圖</p>
                            </div>
                            <button onClick={clearAll} className="text-sm bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg backdrop-blur-sm transition border border-white/10 flex items-center gap-2">
                                <i className="fas fa-trash-alt"></i> 清除重置
                            </button>
                        </div>
                    </div>

                    <div className="max-w-6xl mx-auto mt-10 px-6">
                        {statusMessage && (
                            <div className={`mb-8 px-6 py-4 rounded-xl flex items-center shadow-sm border no-print ${isProcessing ? 'bg-indigo-50 border-indigo-100 text-indigo-800' : 'bg-emerald-50 border-emerald-100 text-emerald-800'}`}>
                                {isProcessing ? <div className="spinner mr-4 border-indigo-600 border-l-transparent"></div> : <i className="fas fa-check-circle text-xl mr-4"></i>}
                                <span className="font-medium">{statusMessage}</span>
                            </div>
                        )}
                        {croppingTarget && renderCropper()}

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10 no-print">
                            {/* Card 1: Order */}
                            <div 
                                className={`bg-white p-1 rounded-2xl shadow-lg border-2 transition-all duration-300 ${dragOverOrder ? 'border-indigo-500 bg-indigo-50 scale-[1.02]' : 'border-slate-100 hover:shadow-xl'}`}
                                onDrop={(e) => handleDrop(e, 'order')}
                                onDragOver={(e) => handleDragOver(e, 'order')}
                                onDragLeave={(e) => handleDragLeave(e, 'order')}
                                onMouseEnter={() => setHoverOrder(true)}
                                onMouseLeave={() => setHoverOrder(false)}
                            >
                                <div className="p-6">
                                    <h2 className="text-lg font-bold text-slate-700 mb-6 flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <span className="bg-indigo-100 text-indigo-600 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">1</span>
                                            上傳商品明細
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => handleScreenCapture('order')} className="text-xs bg-indigo-100 hover:bg-indigo-200 text-indigo-800 px-3 py-1.5 rounded-full font-bold transition flex items-center gap-1">
                                                <i className="fas fa-desktop"></i> 截圖
                                            </button>
                                            {img1 && (
                                                <>
                                                    <label className="cursor-pointer text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded-full font-bold transition flex items-center gap-1">
                                                        <i className="fas fa-sync-alt"></i> 換圖
                                                        <input type="file" accept="image/*,application/pdf" className="hidden" onChange={(e) => handleImageUpload(e, 'order')} />
                                                    </label>
                                                    <button onClick={() => setCroppingTarget('order')} className="text-xs bg-amber-100 hover:bg-amber-200 text-amber-800 px-3 py-1.5 rounded-full font-bold transition flex items-center gap-1">
                                                        <i className="fas fa-crop-alt"></i> 裁切
                                                    </button>
                                                </>
                                            )}
                                        </div>
                                    </h2>
                                    {!img1 ? (
                                        <div className="space-y-4">
                                            <label className="group block w-full cursor-pointer bg-slate-50 border-2 border-dashed border-slate-300 hover:border-indigo-500 rounded-xl p-10 text-center transition duration-300">
                                                <div className="w-16 h-16 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform"><i className="fas fa-cloud-upload-alt text-3xl text-indigo-500"></i></div>
                                                <span className="block text-slate-600 font-medium">點擊/拖放/貼上 (Ctrl+V)</span>
                                                <span className="block text-slate-400 text-xs mt-1">支援 截圖, PDF, JPG, PNG</span>
                                                <input type="file" accept="image/*,application/pdf" className="hidden" onChange={(e) => handleImageUpload(e, 'order')} />
                                            </label>
                                        </div>
                                    ) : (
                                        <div className="relative h-64 bg-slate-100 rounded-xl overflow-hidden border border-slate-200 group"><img src={img1} className="w-full h-full object-contain" /></div>
                                    )}
                                </div>
                            </div>

                            {/* Card 2: Receipt */}
                            <div 
                                className={`bg-white p-1 rounded-2xl shadow-lg border-2 transition-all duration-300 ${dragOverReceipt ? 'border-orange-500 bg-orange-50 scale-[1.02]' : 'border-slate-100 hover:shadow-xl'}`}
                                onDrop={(e) => handleDrop(e, 'receipt')}
                                onDragOver={(e) => handleDragOver(e, 'receipt')}
                                onDragLeave={(e) => handleDragLeave(e, 'receipt')}
                                onMouseEnter={() => setHoverReceipt(true)}
                                onMouseLeave={() => setHoverReceipt(false)}
                            >
                                <div className="p-6">
                                    <h2 className="text-lg font-bold text-slate-700 mb-6 flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <span className="bg-orange-100 text-orange-600 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">2</span>
                                            上傳小白單 (物流單)
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => handleScreenCapture('receipt')} className="text-xs bg-indigo-100 hover:bg-indigo-200 text-indigo-800 px-3 py-1.5 rounded-full font-bold transition flex items-center gap-1">
                                                <i className="fas fa-desktop"></i> 截圖
                                            </button>
                                            {img2 && (
                                                <>
                                                    <label className="cursor-pointer text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded-full font-bold transition flex items-center gap-1">
                                                        <i className="fas fa-sync-alt"></i> 換圖
                                                        <input type="file" accept="image/*,application/pdf" className="hidden" onChange={(e) => handleImageUpload(e, 'receipt')} />
                                                    </label>
                                                    <button onClick={() => setCroppingTarget('receipt')} className="text-xs bg-amber-100 hover:bg-amber-200 text-amber-800 px-3 py-1.5 rounded-full font-bold transition flex items-center gap-1">
                                                        <i className="fas fa-crop-alt"></i> 裁切
                                                    </button>
                                                </>
                                            )}
                                        </div>
                                    </h2>
                                    {!img2 ? (
                                        <label className="group block w-full cursor-pointer bg-slate-50 border-2 border-dashed border-slate-300 hover:border-orange-500 rounded-xl p-10 text-center transition duration-300">
                                            <div className="w-16 h-16 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform"><i className="fas fa-receipt text-3xl text-orange-500"></i></div>
                                            <span className="block text-slate-600 font-medium">點擊/拖放/貼上</span>
                                            <span className="block text-slate-400 text-xs mt-1">游標移至此處按 Ctrl+V</span>
                                            <input type="file" accept="image/*,application/pdf" className="hidden" onChange={(e) => handleImageUpload(e, 'receipt')} />
                                        </label>
                                    ) : (
                                        <div className="relative h-64 bg-slate-100 rounded-xl overflow-hidden border border-slate-200 group"><img src={img2} className="w-full h-full object-contain" /></div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="bg-white p-8 rounded-2xl shadow-lg border border-slate-100 mb-10 no-print">
                            <div className="flex justify-between items-end mb-6 border-b border-slate-100 pb-4">
                                <div><h2 className="text-2xl font-bold text-slate-800">資料編輯區</h2><p className="text-slate-400 text-sm mt-1">確認下方資訊，系統將同步更新至兩張單據</p></div>
                                <span className="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold">Auto Syncing</span>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label className="block text-sm font-semibold text-slate-600">訂單編號</label><input type="text" className="w-full pl-4 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition font-mono text-slate-700" value={orderData.orderId} onChange={(e) => setOrderData({...orderData, orderId: e.target.value})} placeholder="例如: 2601288GNAAPU1" /></div>
                                <div><label className="block text-sm font-semibold text-slate-600">購買人 / 會員帳號</label><input type="text" className="w-full pl-4 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition text-slate-700" value={orderData.buyerName} onChange={(e) => setOrderData({...orderData, buyerName: e.target.value})} placeholder="例如: eh52t70qxs" /></div>
                                <div className="md:col-span-2"><label className="block text-sm font-semibold text-slate-600">商品明細 (補充文字)</label><textarea className="w-full p-4 bg-slate-50 border border-slate-200 rounded-lg h-24 focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition text-slate-700" value={orderData.products} onChange={(e) => setOrderData({...orderData, products: e.target.value})} placeholder="若圖片不清楚，可在此補充文字說明..."></textarea></div>
                                <div><label className="block text-sm font-semibold text-slate-600">備註 (易碎品/發票等)</label><input type="text" className="w-full pl-4 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition text-slate-700" value={orderData.note} onChange={(e) => setOrderData({...orderData, note: e.target.value})} placeholder="例如: 請小心輕放" /></div>
                            </div>
                        </div>

                        <div className="no-print mb-4 flex items-center justify-between">
                            <h3 className="text-lg font-bold text-slate-700 flex items-center gap-2"><i className="fas fa-eye text-slate-400"></i> 列印預覽 (A4)</h3>
                            <div className="text-xs text-slate-400">預覽畫面僅供參考，實際列印效果更佳</div>
                        </div>

                        {/* FINAL OUTPUT - DUAL COPY (Print Area) */}
                        <div className="print-area print-container bg-white shadow-2xl p-10 mx-auto max-w-[210mm] min-h-[297mm] relative mb-20 rounded-sm">
                            <BillTemplate titleTag="賣家存根聯" orderData={orderData} img1={img1} img2={img2} mode="keep" />
                            <div className="cut-separator no-print-placeholder" style={{margin: '10px 0', borderTop: '2px dashed #999', position: 'relative', height: '2px', flexShrink: 0}}></div>
                            <BillTemplate titleTag="隨貨寄出聯" orderData={orderData} img1={img1} img2={img2} mode="cut" />
                        </div>

                        <div className="fixed bottom-8 right-8 flex flex-col items-end gap-3 no-print z-[99999]">
                             <div className="text-xs text-slate-500 bg-white/90 px-3 py-1.5 rounded-lg shadow-md backdrop-blur-sm border border-white"><i className="fas fa-info-circle mr-1"></i> 若按鈕無效請按 Ctrl+P</div>
                            <div className="flex gap-4">
                                <button onClick={handlePrint} className="group bg-gradient-to-r from-indigo-600 to-violet-600 text-white px-8 py-3 rounded-full shadow-2xl hover:shadow-indigo-500/30 hover:scale-105 active:scale-95 transition-all duration-300 flex items-center font-bold text-lg cursor-pointer border-[3px] border-white ring-2 ring-indigo-200">
                                    <div className="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center mr-3 group-hover:rotate-12 transition-transform"><i className="fas fa-print"></i></div>列印 / 儲存 PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
